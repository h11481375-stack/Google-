<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoe DIY - Gemini AI</title>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Zoe DIY Gemini 助手",
      "description": "基于 Google Gemini API 的 DIY 手工助手"
    }
    </script>
    <style>
        /* 保持之前的样式不变，为了简洁这里略过，建议使用你之前代码里的完整 CSS */
        body, html { height: 100%; margin: 0; font-family: sans-serif; background-color: #343541; color: white; display: flex; flex-direction: column; }
        #setup-area { background: #202123; padding: 15px; border-bottom: 1px solid #4d4d4f; }
        .key-container { display: flex; gap: 10px; max-width: 800px; margin: 0 auto; }
        #keyInput { flex: 1; background: #40414f; border: 1px solid #565869; color: white; padding: 12px; border-radius: 8px; outline: none; }
        #confirmBtn { background-color: #10a37f; color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #chat-container { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .message-row { width: 100%; display: flex; justify-content: center; padding: 20px 0; }
        .ai-row { background-color: #444654; }
        .message-content { width: 90%; max-width: 800px; display: flex; gap: 15px; }
        .avatar { width: 30px; height: 30px; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0; }
        .ai-avatar { background-color: #4285f4; } /* Google 蓝 */
        .user-avatar { background-color: #5436da; }
        .text { font-size: 15px; line-height: 1.6; word-break: break-all; }
        .input-area { padding: 20px; background: #343541; display: flex; justify-content: center; }
        .input-wrapper { position: relative; width: 90%; max-width: 800px; }
        #userInput { width: 100%; background: #40414f; border-radius: 12px; padding: 14px; color: white; border: 1px solid #202123; outline: none; box-sizing: border-box; }
        #sendBtn { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #acacbe; cursor: pointer; font-size: 20px; }
    </style>
</head>
<body>

    <div id="setup-area">
        <div class="key-container">
            <input type="password" id="keyInput" placeholder="粘贴 Google Gemini API Key" autocomplete="new-password">
            <button id="confirmBtn" onclick="confirmKey()">确认</button>
        </div>
    </div>

    <div id="chat-container">
        <div class="message-row ai-row">
            <div class="message-content">
                <div class="avatar ai-avatar">G</div>
                <div class="text">你好！我是由 Google Gemini 驱动的 DIY 助手。请输入 Key 开始。</div>
            </div>
        </div>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <input type="text" id="userInput" placeholder="问问我关于 DIY 的事..." autocomplete="off">
            <button id="sendBtn" onclick="handleSend()">✈</button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('userInput');
        const keyInput = document.getElementById('keyInput');

        function confirmKey() {
            if (keyInput.value.trim()) {
                alert("✅ Gemini Key 已就绪！");
                userInput.focus();
            } else {
                alert("❌ 请输入 Key");
            }
        }

        async function handleSend() {
            const text = userInput.value.trim();
            const apiKey = keyInput.value.trim();

            if (!text || !apiKey) return;

            addMessage(text, 'user');
            userInput.value = '';

            const tempId = 'ai-' + Date.now();
            addMessage("Gemini 正在思考...", 'ai', tempId);

            try {
                // 注意：Gemini 的 URL 格式和智谱完全不同
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: text + " (请作为一名 DIY 手工大师回答我)" }]
                        }]
                    })
                });

                const data = await response.json();
                
                // Gemini 的返回数据路径是 data.candidates[0].content.parts[0].text
                const aiReply = data.candidates[0].content.parts[0].text;
                document.getElementById(tempId).innerText = aiReply;

            } catch (err) {
                document.getElementById(tempId).innerText = "错误: 请检查网络（Gemini 需要海外环境）或 Key 是否正确。";
                console.error(err);
            }
        }

        function addMessage(text, role, id = null) {
            const isAi = role === 'ai';
            const html = `<div class="message-row ${isAi ? 'ai-row' : ''}"><div class="message-content"><div class="avatar ${isAi ? 'ai-avatar' : 'user-avatar'}">${isAi ? 'G' : '你'}</div><div class="text" ${id ? `id="${id}"` : ''}>${text}</div></div></div>`;
            chatContainer.insertAdjacentHTML('beforeend', html);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        keyInput.addEventListener('keypress', (e) => { e.key === 'Enter' && confirmKey(); });
        userInput.addEventListener('keypress', (e) => { e.key === 'Enter' && handleSend(); });
    </script>
</body>
</html>
